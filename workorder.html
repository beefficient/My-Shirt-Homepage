<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Work Order Builder (MVP)</title>

  <style>
    :root{
      --bg:#f6faf7;
      --surface:#ffffff;
      --border:#d8e5db;
      --text:#173028;
      --muted:#456057;
      --accent:#2f7a5a;
      --accent2:#e8f6ee;
      --danger:#a63a3a;
      --shadow: 0 10px 24px rgba(10,35,45,.08);
      --radius:14px;
      --container:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    .container{max-width:var(--container);margin:0 auto;padding:18px}
    h1{margin:0 0 6px;font-size:24px}
    .muted{color:var(--muted)}
    .topbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:13px}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px;align-items:start;margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,.04)}
    .cardHeader{padding:14px 14px 0}
    .cardTitle{display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:800}
    .cardBody{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);font-size:14px;background:#fff}
    textarea{min-height:92px;resize:vertical}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid transparent;background:var(--accent);color:#fff;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--text);border-color:var(--border)}
    .btn.ghost{background:transparent;color:var(--text);border-color:transparent}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;font-size:13px}
    .tab.active{background:var(--accent2)}
    .hidden{display:none !important}
    hr{border:none;border-top:1px solid rgba(0,0,0,.08);margin:14px 0}
    .itemCard{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .itemTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px;font-weight:800}
    .help{font-size:12px;color:var(--muted)}
    .sizeBox{border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--accent2)}
    .sizeRow{display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap}
    .sizeRow .sizeLbl{width:54px;font-weight:800}
    .sizeRow input[type="number"]{max-width:140px}
    .inline2{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    .inline3{display:grid;grid-template-columns:1fr 2fr;gap:12px}
    @media (max-width: 820px){ .inline2,.inline3{grid-template-columns:1fr} }
    .imgPreview{width:100%;max-height:240px;object-fit:contain;border:1px solid var(--border);border-radius:14px;background:#fff}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#fff;border:1px solid var(--border);border-radius:999px;padding:10px 14px;box-shadow:var(--shadow);font-weight:700;z-index:1000}
    .toast.error{border-color:var(--danger);color:var(--danger)}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);max-width:900px;width:100%}
    .modalHeader{padding:14px;border-bottom:1px solid rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalBody{padding:14px;max-height:75vh;overflow:auto}
    .modalBody img{max-width:100%;height:auto;display:block}
    .modalFooter{padding:14px;border-top:1px solid rgba(0,0,0,.08);display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    /* Preview (modal) 2-column layout for each item */
    .previewGrid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 820px){
      .previewGrid{ grid-template-columns:1fr; }
    }
    .previewImages{
      display:grid;
      gap:10px;
    }
    .previewImages img{
      width:100%;
      max-height:240px;        /* match your normal webpage image height */
      object-fit:contain;
      border:1px solid #bbb;
      border-radius:10px;
      background:#fff;
    }

    /* Required field highlighting */
    .reqMark{color:var(--danger);font-weight:900;margin-left:4px}
    .invalid{border-color:var(--danger) !important; box-shadow:0 0 0 3px rgba(166,58,58,.14) !important}

    /* Print */
    @media print{
      .noPrint{display:none !important}
      body{background:#fff; font-size:11px; line-height:1.25}

      /* Try to keep to one page */
      @page { margin: 0.35in; } /* tight margins */

      .printOnly{display:block !important}
      .printCard{
        border:1px solid #bbb;
        border-radius:8px;
        padding:8px;
        margin:0 0 8px 0;
        page-break-inside: avoid;
        break-inside: avoid;
      }

      /* Make item images SMALL */
      .printCard img{
        max-height:140px !important;
        width:auto !important;
        max-width:100% !important;
        object-fit:contain !important;
      }

      /* Print 2-column item layout */
      .printItemGrid{
        display:grid;
        grid-template-columns: 1.25fr .75fr;
        gap:10px;
        align-items:start;
      }
      .printItemImages{
        display:grid;
        gap:8px;
        justify-items:end;
      }
      .printItemImages img{
        width:100% !important;
        max-height:160px !important;  /* smaller for print */
        object-fit:contain !important;
        border:1px solid #bbb;
        border-radius:8px;
        background:#fff;
      }

      /* Prevent awkward splits */
      .printSection, .printRow, .printCard { page-break-inside: avoid; break-inside: avoid; }

      /* Hide links styling */
      a{color:inherit;text-decoration:none}
    }
    .printOnly{display:none}
  </style>
</head>

<body>
  <div class="container noPrint">
    <div class="topbar">
      <div>
        <h1>Work Order Builder</h1>
        <div class="muted">Create a clear, shop-ready work order and get customer approval.</div>
      </div>

      <div class="btnRow">
        <span class="pill"><b>Status:</b> <span id="statusPill">Draft</span></span>
        <button class="btn secondary" id="newWO">New Work Order</button>
        <button class="btn secondary" id="previewCustomer">Preview Customer View</button>
        <button class="btn" id="printBtn">Print / Save PDF</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">
            <span>Work Order Details</span>
            <span class="muted" id="woNumber"></span>
          </div>
        </div>

        <div class="cardBody">
          <div class="row">
            <div>
              <label>Created Date <span class="reqMark">*</span></label>
              <input type="date" id="createdDate" required>
            </div>
            <div>
              <label>Due Date <span class="reqMark">*</span></label>
              <input type="date" id="dueDate" required>
            </div>
          </div>

          <hr>

          <div class="row">
            <div>
              <label>Customer Name <span class="reqMark">*</span></label>
              <input id="customerName" placeholder="Full name" required>
            </div>
            <div>
              <label>Company</label>
              <input id="company" placeholder="Optional">
            </div>
            <div>
              <label>Email <span class="reqMark">*</span></label>
              <input id="email" placeholder="customer@email.com" required>
            </div>
            <div>
              <label>Phone</label>
              <input id="phone" placeholder="(555) 555-5555">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Billing Address</label>
              <textarea id="billingAddress" placeholder="Street, City, State, ZIP"></textarea>
            </div>
            <div>
              <label>Shipping / Pickup Notes <span class="reqMark">*</span></label>
              <textarea id="shippingAddress" placeholder="Pickup / ship to..." required></textarea>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" data-tab="items">Items</button>
            <button class="tab" data-tab="notes">Notes</button>
            <button class="tab" data-tab="approval">Customer Approval</button>
          </div>

          <!-- ITEMS TAB -->
          <div id="tab-items" style="margin-top:10px">
            <div class="btnRow" style="justify-content:space-between">
              <div class="muted">Add each product/service line so production has everything they need.</div>
              <div class="btnRow">
                <label class="pill" style="gap:10px">
                  <input type="checkbox" id="sameArtNext" style="width:auto">
                  Use same artwork for next item
                </label>
                <button class="btn" id="addItem">Add Item</button>
              </div>
            </div>

            <div id="itemsWrap" style="margin-top:12px;display:grid;gap:12px"></div>
          </div>

          <!-- NOTES TAB -->
          <div id="tab-notes" class="hidden" style="margin-top:10px">
            <div class="row">
              <div>
                <label>Notes (Customer will see) <span class="reqMark">*</span></label>
                <textarea id="notesCustomer" placeholder="Customer-facing instructions, pickup details, etc." required></textarea>
              </div>
              <div>
                <label>Internal Notes (Shop only) <span class="reqMark">*</span></label>
                <textarea id="notesInternal" placeholder="Press notes, special handling, vendor notes, etc." required></textarea>
              </div>
            </div>
          </div>

          <!-- APPROVAL TAB -->
          <div id="tab-approval" class="hidden" style="margin-top:10px">
            <div class="itemCard">
              <div class="itemTop">
                <div>
                  <div style="font-weight:900">Customer Approval</div>
                  <div class="muted">Customer approves details before production begins.</div>
                </div>
                <span class="badge" id="approvalBadge">Awaiting approval</span>
              </div>

              <div style="margin-top:10px">
                <label style="margin-top:0">Terms <span class="reqMark">*</span></label>
                <div style="display:flex;gap:10px;align-items:flex-start">
                  <input type="checkbox" id="termsAccepted" style="width:auto;margin-top:3px">
                  <div class="muted">
                    I confirm the details above are correct and authorize production to begin.
                    I understand changes after approval may affect due dates.
                  </div>
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Type your name to approve <span class="reqMark">*</span></label>
                    <input id="approvedName" placeholder="Customer name" required>
                  </div>
                  <div>
                    <label>Approval Date</label>
                    <input id="approvedDate" placeholder="Set on approval" disabled>
                  </div>
                </div>

                <div class="btnRow" style="margin-top:10px">
                  <button class="btn" id="markApproved">Mark Approved</button>
                  <button class="btn secondary" id="clearApproval">Clear Approval</button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div style="display:grid;gap:14px">
        <div class="card">
          <div class="cardHeader"><div class="cardTitle">Quick Summary</div></div>
          <div class="cardBody" style="display:grid;gap:10px">
            <div class="itemCard">
              <div class="help">Items</div>
              <div style="font-size:22px;font-weight:900" id="summaryItems">1</div>
            </div>
            <div class="itemCard">
              <div class="help">Due date</div>
              <div><b>Due:</b> <span id="summaryDueDate">-</span></div>
            </div>
            <div class="itemCard">
              <div class="help">Approval</div>
              <div><b>Status:</b> <span id="summaryStatus">Draft</span></div>
              <div class="help" id="summaryApprovedDate"></div>
            </div>
            <div class="help">Drafts auto-save on this device.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PRINT VIEW -->
  <div class="printOnly" id="printView"></div>

  <!-- CUSTOMER PREVIEW MODAL -->
  <div class="modalBackdrop hidden noPrint" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div style="font-weight:900">Customer Preview</div>
        <button class="btn ghost" id="closeModal">âœ•</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFooter">
        <button class="btn secondary" id="modalPrint">Print Preview</button>
        <button class="btn" id="modalClose2">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden noPrint"></div>

<script>
(function(){
  // ====== CONFIG ======
  const SERVICE_TYPES = [
    "Screen Printing",
    "Heat Transfers",
    "Embroidery",
    "Sublimation",
    "Banners",
    "Stickers/Decals",
    "Business Cards",
    "Flyers",
    "Other",
  ];
  const GARMENT_SERVICES = new Set([
    "Screen Printing",
    "Heat Transfers",
    "Embroidery",
    "Sublimation",
  ]);
  const DEFAULT_SIZES = ["XS","S","M","L","XL","2XL","3XL","4XL"];

  const DRAFT_KEY = "workorder_mvp_html_v4_required_fields";

  // ====== HELPERS ======
  const $ = (id) => document.getElementById(id);
  const esc = (s) => String(s ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const isGarment = (type) => GARMENT_SERVICES.has(String(type||""));
  const todayISO = () => {
    const d = new Date();
    const pad = (v)=>String(v).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const buildWONumber = () => {
    const d = new Date();
    const pad = (v)=>String(v).padStart(2,"0");
    const ymd = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
    const rand = Math.floor(Math.random()*9000+1000);
    return `WO-${ymd}-${rand}`;
  };
  const toast = (msg, type="success", ms=2500) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.remove("hidden","error");
    if(type==="error") t.classList.add("error");
    window.clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.add("hidden"), ms);
  };
  const newSizeBreakdown = () => DEFAULT_SIZES.map(s => ({ size:s, enabled:false, qty:0 }));
  const sizeTotal = (rows) => Array.isArray(rows) ? rows.reduce((sum,r)=>sum + (r.enabled ? Number(r.qty||0) : 0), 0) : 0;

  const readFileAsDataUrl = (file) => new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(String(r.result||""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  function artworkKeyForItem(item){
    const ids = Array.isArray(item.artworkIds) ? item.artworkIds : [];
    if(!ids.length) return `NO_ART_${item.id}`; // keep no-art items separate
    // Key is based on the exact artwork IDs (order-sensitive)
    return ids.join("|");
  }

  async function waitForImages(root){
    const imgs = Array.from(root.querySelectorAll("img"));
    if(!imgs.length) return;

    await Promise.all(imgs.map(async (img) => {
      try{
        // decode() is the most reliable when available (Chrome/Safari)
        if (img.decode) {
          await img.decode();
          return;
        }
      }catch(e){}
      // fallback
      if(img.complete) return;
      await new Promise(res => { img.onload = res; img.onerror = res; });
    }));
  }

  function clearInvalids(){
    document.querySelectorAll(".invalid").forEach(el => el.classList.remove("invalid"));
  }
  function markInvalid(el){
    if(!el) return;
    el.classList.add("invalid");
  }
  function focusFirstInvalid(){
    const el = document.querySelector(".invalid");
    if(el) el.scrollIntoView({ behavior:"smooth", block:"center" });
    if(el && typeof el.focus === "function") el.focus();
  }

  // ====== STATE ======
  let wo = null;

  const defaultItem = () => ({
    id: crypto.randomUUID(),
    serviceType: "Screen Printing",
    product: "",
    itemSize: "",
    variantColor: "",
    sizeBreakdown: newSizeBreakdown(),
    quantity: 0,
    location: "",
    inkColors: "",
    artNotes: "",      // OPTIONAL
    artworkIds: [],    // references into wo.artworks[]
  });

  const newWO = () => ({
    woNumber: buildWONumber(),
    createdDate: todayISO(),
    dueDate: "",
    customerName: "",
    company: "",          // OPTIONAL
    email: "",
    phone: "",
    billingAddress: "",
    shippingAddress: "",
    notesCustomer: "",
    notesInternal: "",
    items: [defaultItem()],
    artworks: [], // shared artwork library for this work order
    approval: { approved:false, approvedName:"", approvedDate:"", termsAccepted:false }
  });

  // ====== LOAD/SAVE ======
  function loadDraft(){
    const raw = localStorage.getItem(DRAFT_KEY);
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);

      // Ensure shared library exists
      if(!Array.isArray(parsed.artworks)) parsed.artworks = [];

      if(Array.isArray(parsed.items)){
        parsed.items = parsed.items.map(it => {
          const next = {
            ...defaultItem(),
            ...it,
            sizeBreakdown: Array.isArray(it.sizeBreakdown) ? it.sizeBreakdown : newSizeBreakdown(),
            quantity: typeof it.quantity === "number" ? it.quantity : Number(it.quantity||0)
          };
          
          // Back-compat: migrate old images into shared artworks + item.artworkIds
          const legacyImgs = [];
          if(next.image?.dataUrl) legacyImgs.push(next.image);
          if(Array.isArray(next.images)) legacyImgs.push(...next.images);

          if(!Array.isArray(next.artworkIds)) next.artworkIds = [];

          for(const im of legacyImgs){
            if(!im?.dataUrl) continue;

            let existing = parsed.artworks.find(a => a.dataUrl === im.dataUrl);
            if(!existing){
              existing = { id: crypto.randomUUID(), name: im.name || "artwork", dataUrl: im.dataUrl };
              parsed.artworks.push(existing);
            }
            if(!next.artworkIds.includes(existing.id)){
              next.artworkIds.push(existing.id);
            }
          }

          delete next.image;
          delete next.images;
          
          delete next.dueDate; // ignore old item due dates
          return next;
        });
      }

      wo = { ...newWO(), ...parsed };
      if(!wo.createdDate) wo.createdDate = todayISO();
    }catch(e){}
  }
  function saveDraft(){
    try{
      localStorage.setItem(DRAFT_KEY, JSON.stringify(wo));
    }catch(e){
      console.warn("Draft save failed:", e);
      toast(
        "Draft too large to save on this device. Remove some images or use smaller files, then try again.",
        "error",
        6500
      );
    }
  }

  // ====== VALIDATION ======
  function validateAllRequired({ includeApproval = false } = {}){
    clearInvalids();

    // Top-level required fields (company is optional)
    const requiredTop = [
      { id:"createdDate", label:"Created Date" },
      { id:"dueDate", label:"Due Date" },
      { id:"customerName", label:"Customer Name" },
      { id:"email", label:"Email" },
      { id:"shippingAddress", label:"Shipping / Pickup Notes" },
      { id:"notesCustomer", label:"Customer Notes" },
      { id:"notesInternal", label:"Internal Notes" },
    ];

    const missing = [];

    for(const f of requiredTop){
      const el = $(f.id);
      const val = (el?.value ?? "").trim();
      if(!val){
        missing.push(f.label);
        markInvalid(el);
      }
    }

    // Items required fields (artNotes + image are OPTIONAL)
    if(!wo.items.length){
      missing.push("At least one item");
    }else{
      wo.items.forEach((it) => {
        // product required
        if(!String(it.product||"").trim()){
          missing.push("Item: Product / Description");
          const el = document.querySelector(`input[data-field="product"][data-id="${it.id}"]`);
          markInvalid(el);
        }

        // location required
        if(!String(it.location||"").trim()){
          missing.push("Item: Location / Finish");
          const el = document.querySelector(`input[data-field="location"][data-id="${it.id}"]`);
          markInvalid(el);
        }

        // inkColors required
        if(!String(it.inkColors||"").trim()){
          missing.push("Item: Colors / Material");
          const el = document.querySelector(`input[data-field="inkColors"][data-id="${it.id}"]`);
          markInvalid(el);
        }

        if(isGarment(it.serviceType)){
          const total = sizeTotal(it.sizeBreakdown);
          if(total <= 0){
            missing.push("Item: Size breakdown (select sizes + quantities)");
            // mark first size checkbox as invalid to show where to fix
            const el = document.querySelector(`input[type="checkbox"][data-sizecheck^="${it.id}:"]`);
            markInvalid(el);
          }
        }else{
          // itemSize required
          if(!String(it.itemSize||"").trim()){
            missing.push("Item: Item Size / Dimensions");
            const el = document.querySelector(`input[data-field="itemSize"][data-id="${it.id}"]`);
            markInvalid(el);
          }
          // quantity required (>0)
          if(Number(it.quantity||0) <= 0){
            missing.push("Item: Quantity");
            const el = document.querySelector(`input[data-field="quantity"][data-id="${it.id}"]`);
            markInvalid(el);
          }
        }
      });
    }

    // Approval-specific required fields
    if(includeApproval){
      if(!wo.approval.termsAccepted){
        missing.push("Approval: Terms checked");
        markInvalid($("termsAccepted"));
      }
      if(!String(wo.approval.approvedName||"").trim()){
        missing.push("Approval: Name typed");
        markInvalid($("approvedName"));
      }
    }

    if(missing.length){
      // de-dupe
      const uniq = [...new Set(missing)];
      toast("Missing required fields:\nâ€¢ " + uniq.join("\nâ€¢ "), "error", 5200);
      focusFirstInvalid();
      return false;
    }
    return true;
  }

  // ====== RENDER ======
  function updateSummary(){
    $("woNumber").textContent = wo.woNumber;
    $("createdDate").value = wo.createdDate || todayISO();
    $("dueDate").value = wo.dueDate || "";
    $("customerName").value = wo.customerName || "";
    $("company").value = wo.company || "";
    $("email").value = wo.email || "";
    $("phone").value = wo.phone || "";
    $("billingAddress").value = wo.billingAddress || "";
    $("shippingAddress").value = wo.shippingAddress || "";
    $("notesCustomer").value = wo.notesCustomer || "";
    $("notesInternal").value = wo.notesInternal || "";

    // approval UI
    $("termsAccepted").checked = !!wo.approval.termsAccepted;
    $("approvedName").value = wo.approval.approvedName || "";
    $("approvedDate").value = wo.approval.approvedDate || "";
    const status = wo.approval.approved ? "Approved" : "Draft";
    $("statusPill").textContent = status;
    $("summaryStatus").textContent = status;
    $("approvalBadge").textContent = wo.approval.approved ? `Approved ${wo.approval.approvedDate||""}` : "Awaiting approval";
    $("summaryApprovedDate").textContent = wo.approval.approved ? `Approved on ${wo.approval.approvedDate||""}` : "Not approved yet";

    $("summaryItems").textContent = String(wo.items.length);
    $("summaryDueDate").textContent = wo.dueDate || "-";
  }

  function sizeFieldLabel(type){
    return isGarment(type) ? "Sizes / Breakdown" : "Item Size / Dimensions";
  }
  function sizeFieldHelp(type){
    return isGarment(type)
      ? "Check sizes and enter quantities. Total auto-calculates."
      : 'Examples: 2ft Ã— 6ft banner, 3" Ã— 3" sticker, 8.5" Ã— 11" flyer.';
  }
  function locationLabel(type){
    return isGarment(type) ? "Print Location" : "Finish / Placement";
  }
  function locationPlaceholder(type){
    return isGarment(type) ? "Front / Back / Sleeve" : "e.g., Grommets, Hem, Laminate, Double-sided, Cut path";
  }
  function colorsLabel(type){
    return isGarment(type) ? "Ink / Thread Colors" : "Colors / Material";
  }
  function colorsPlaceholder(type){
    return isGarment(type) ? "White, Red (2 colors)" : "e.g., Full color, CMYK, Vinyl color, Paper stock";
  }

  function renderItems(){
    const wrap = $("itemsWrap");
    wrap.innerHTML = "";

    wo.items.forEach((it, idx) => {
      const garment = isGarment(it.serviceType);

      const card = document.createElement("div");
      card.className = "itemCard";

      card.innerHTML = `
        <div class="itemTop">
          <span class="badge">Item ${idx+1}</span>
          <div class="btnRow">
            <button class="btn secondary" data-action="dupColor" data-id="${it.id}">
              Same item, different color
            </button>
            <button class="btn ghost" data-action="remove" data-id="${it.id}" ${wo.items.length<=1 ? "disabled" : ""}>ðŸ—‘ Remove</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Service Type <span class="reqMark">*</span></label>
            <select data-field="serviceType" data-id="${it.id}">
              ${SERVICE_TYPES.map(s => `<option ${s===it.serviceType?"selected":""}>${esc(s)}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>Product / Description <span class="reqMark">*</span></label>
            <input data-field="product" data-id="${it.id}" value="${esc(it.product)}" placeholder="e.g., 100x tees + 2-color front print" required>
          </div>
        </div>

        <div class="inline2" style="margin-top:6px">
          <div>
            <label>${esc(sizeFieldLabel(it.serviceType))} <span class="reqMark">*</span></label>
            <div data-slot="sizeArea"></div>
          </div>

          <div>
            <label>Total Quantity <span class="reqMark">*</span></label>
            <input type="number" min="0" data-field="quantity" data-id="${it.id}" value="${Number(it.quantity||0)}" ${garment ? "disabled" : ""} ${garment ? "" : "required"}>
            ${garment ? `<div class="help">Auto-calculated from size breakdown.</div>` : `<div class="help">Manual for non-garment items.</div>`}
          </div>
        </div>

        <div class="inline3" style="margin-top:6px">
          <div>
            <label>${esc(locationLabel(it.serviceType))} <span class="reqMark">*</span></label>
            <input data-field="location" data-id="${it.id}" value="${esc(it.location)}" placeholder="${esc(locationPlaceholder(it.serviceType))}" required>
          </div>
          <div>
            <label>${esc(colorsLabel(it.serviceType))} <span class="reqMark">*</span></label>
            <input data-field="inkColors" data-id="${it.id}" value="${esc(it.inkColors)}" placeholder="${esc(colorsPlaceholder(it.serviceType))}" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Artwork / Production Notes</label>
            <textarea data-field="artNotes" data-id="${it.id}" placeholder="Pantone, underbase, proof notes, finishing notes...">${esc(it.artNotes)}</textarea>
            <div class="help">Optional</div>
          </div>
          <div>
            <label>Item Image / Mockup</label>
            <div data-slot="imageArea"></div>
            <div class="help" style="margin-top:8px">Optional (keep images under 6MB so drafts save reliably).</div>
          </div>
        </div>
      `;

      // size area
      const sizeArea = card.querySelector('[data-slot="sizeArea"]');
      if(garment){
        const box = document.createElement("div");
        box.className = "sizeBox";
        box.innerHTML = `
          <div class="help">${esc(sizeFieldHelp(it.serviceType))}</div>

          <label style="margin-top:10px">Shirt Color (optional)</label>
          <input data-field="variantColor" data-id="${it.id}" value="${esc(it.variantColor||"")}"
                 placeholder="Black, Navy, Heather Gray">
        `;

        it.sizeBreakdown.forEach((r, rIdx) => {
          const row = document.createElement("div");
          row.className = "sizeRow";
          row.innerHTML = `
            <input type="checkbox" data-sizecheck="${it.id}:${rIdx}" ${r.enabled ? "checked" : ""} style="width:auto">
            <div class="sizeLbl">${esc(r.size)}</div>
            <input type="number" min="0" data-sizeqty="${it.id}:${rIdx}" value="${Number(r.qty||0)}" ${r.enabled ? "" : "disabled"}>
          `;
          box.appendChild(row);
        });
        sizeArea.appendChild(box);
      }else{
        const box = document.createElement("div");
        box.innerHTML = `
          <input data-field="itemSize" data-id="${it.id}" value="${esc(it.itemSize)}" placeholder='e.g., 2ft Ã— 6ft banner, 3" Ã— 3" sticker' required>
          <div class="help">${esc(sizeFieldHelp(it.serviceType))}</div>
        `;
        sizeArea.appendChild(box);
      }

      // image area (shared artwork)
      const imageArea = card.querySelector('[data-slot="imageArea"]');
      const ids = Array.isArray(it.artworkIds) ? it.artworkIds : [];
      const imgs = ids.map(id => wo.artworks.find(a => a.id === id)).filter(Boolean);

      if(imgs.length){
        imageArea.innerHTML = `
          <div style="display:grid;gap:10px">
            ${imgs.map((im, imIdx) => `
              <div style="border:1px solid var(--border);border-radius:14px;padding:10px;background:#fff">
                <img class="imgPreview" src="${im.dataUrl}" alt="${esc(im.name||"mockup")}">
                <div class="help" style="margin-top:6px">${esc(im.name||"")}</div>
                <div class="btnRow" style="margin-top:8px">
                  <button class="btn secondary" data-action="removeArtworkRef" data-id="${it.id}" data-idx="${imIdx}">Remove</button>
                </div>
              </div>
            `).join("")}

            <div class="btnRow">
              <input type="file" accept="image/*" multiple data-action="uploadArtwork" data-id="${it.id}">
              <button class="btn secondary" data-action="clearArtworkRefs" data-id="${it.id}">Clear all</button>
            </div>
            <div class="help">Uploads are stored once per work order and reused across items.</div>
          </div>
        `;
      }else{
        imageArea.innerHTML = `
          <input type="file" accept="image/*" multiple data-action="uploadArtwork" data-id="${it.id}">
        `;
      }

      wrap.appendChild(card);
    });
  }

  function renderAll(){
    updateSummary();
    renderItems();
    saveDraft();
  }

  // ====== APPROVAL ======
  function markApproved(){
    if(!validateAllRequired({ includeApproval: true })) return;

    wo.approval.approved = true;
    wo.approval.approvedDate = todayISO();
    toast("Marked as approved.");
    renderAll();
  }

  function clearApproval(){
    wo.approval.approved = false;
    wo.approval.approvedDate = "";
    toast("Approval cleared.");
    renderAll();
  }

  // ====== CUSTOMER PREVIEW ======
  async function openPreview(){
    validateAllRequired({ includeApproval: false }); // warn + highlight, but don't block

    // Group items by artwork
    const groupsMap = new Map();
    for(const item of wo.items){
      const key = artworkKeyForItem(item);
      if(!groupsMap.has(key)) groupsMap.set(key, []);
      groupsMap.get(key).push(item);
    }
    const groups = Array.from(groupsMap.values());

    const html = `
      <div class="muted"><b>Work Order:</b> ${esc(wo.woNumber)}</div>
      <div style="margin-top:6px"><b>Customer:</b> ${esc(wo.customerName || "(missing)")}</div>
      <div><b>Due Date:</b> ${esc(wo.dueDate || "-")}</div>
      <hr>
      <div style="display:grid;gap:10px">
        ${groups.map((itemsInGroup, gIdx) => {
          const ids = Array.isArray(itemsInGroup[0].artworkIds) ? itemsInGroup[0].artworkIds : [];
          const imgs = ids.map(id => wo.artworks.find(a => a.id === id)).filter(Boolean);

          return `
            <div class="itemCard">
              <div style="font-weight:900;margin-bottom:8px">
                Group ${gIdx+1}
                ${itemsInGroup.length > 1 ? `<span class="muted" style="font-weight:700">Â· ${itemsInGroup.length} items</span>` : ``}
              </div>

              <div class="previewGrid">
                <div style="display:grid;gap:10px">
                  ${itemsInGroup.map((i, idx) => `
                    <div>
                      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                        <div style="font-weight:900">${esc(i.serviceType)}${itemsInGroup.length>1 ? ` <span class="muted" style="font-weight:700">Â· Item ${idx+1}</span>` : ``}</div>
                        <div class="muted"><b>Qty</b> ${Number(i.quantity||0)}</div>
                      </div>

                      <div style="margin-top:6px">${esc(i.product || "(missing description)")}</div>

                      ${isGarment(i.serviceType) && i.variantColor?.trim()
                        ? `<div style="margin-top:6px"><b>Shirt Color:</b> ${esc(i.variantColor)}</div>`
                        : ``}

                      <div style="margin-top:6px">
                        <div>
                          <b>${esc(sizeFieldLabel(i.serviceType))}:</b>
                          ${
                            isGarment(i.serviceType)
                              ? (i.sizeBreakdown.filter(r=>r.enabled && Number(r.qty||0)>0).length
                                  ? i.sizeBreakdown.filter(r=>r.enabled && Number(r.qty||0)>0).map(r=>`${esc(r.size)}-${Number(r.qty||0)}`).join(", ")
                                  : "-"
                                )
                              : (esc(i.itemSize||"-"))
                          }
                        </div>
                        <div style="margin-top:4px">
                          <b>Location:</b> ${esc(i.location||"-")} &nbsp; Â· &nbsp;
                          <b>Colors:</b> ${esc(i.inkColors||"-")}
                        </div>
                      </div>

                      ${i.artNotes?.trim()
                        ? `<div style="margin-top:6px"><b>Notes:</b> <span style="white-space:pre-wrap">${esc(i.artNotes)}</span></div>`
                        : ``}
                    </div>
                  `).join('<hr style="border:none;border-top:1px solid rgba(0,0,0,.08);margin:6px 0">')}
                </div>

                <div class="previewImages">
                  ${
                    imgs.length
                      ? imgs.map(im => `<img src="${im.dataUrl}" alt="">`).join("")
                      : ``
                  }
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    $("modalBody").innerHTML = html;
    
    // Wait for all images to load before showing modal
    await waitForImages($("modalBody"));
    
    $("modalBackdrop").classList.remove("hidden");
  }
  function closePreview(){
    $("modalBackdrop").classList.add("hidden");
  }

  // ====== PRINT VIEW ======
  function buildPrintView(){
    const status = wo.approval.approved ? "Approved" : "Draft";
    
    // Group items by artwork
    const groupsMap = new Map();
    for(const item of wo.items){
      const key = artworkKeyForItem(item);
      if(!groupsMap.has(key)) groupsMap.set(key, []);
      groupsMap.get(key).push(item);
    }
    const groups = Array.from(groupsMap.values());

    const items = groups.map((itemsInGroup, gIdx) => {
      const ids = Array.isArray(itemsInGroup[0].artworkIds) ? itemsInGroup[0].artworkIds : [];
      const imgs = ids.map(id => wo.artworks.find(a => a.id === id)).filter(Boolean);
      const printImgs = imgs.slice(0, 2); // keep print clean (2 max)

      return `
        <div class="printCard">
          <div class="printItemGrid">
            <div>
              ${itemsInGroup.map((i, idx) => `
                <div ${idx > 0 ? 'style="margin-top:8px;padding-top:8px;border-top:1px solid #ddd"' : ''}>
                  <div style="font-weight:900">${esc(i.serviceType)} <span style="font-weight:600">Â· Qty ${Number(i.quantity||0)}</span></div>
                  <div style="margin-top:2px">${esc(i.product||"-")}</div>

                  ${isGarment(i.serviceType) && i.variantColor?.trim()
                    ? `<div style="margin-top:2px"><b>Shirt:</b> ${esc(i.variantColor)}</div>`
                    : ``}

                  <div style="margin-top:2px">
                    <b>${esc(sizeFieldLabel(i.serviceType))}:</b>
                    ${
                      isGarment(i.serviceType)
                        ? (i.sizeBreakdown.filter(r=>r.enabled && Number(r.qty||0)>0).length
                            ? i.sizeBreakdown.filter(r=>r.enabled && Number(r.qty||0)>0).map(r=>`${esc(r.size)}-${Number(r.qty||0)}`).join(", ")
                            : "-"
                          )
                        : (esc(i.itemSize||"-"))
                    }
                    <br>
                    <b>Location:</b> ${esc(i.location||"-")} &nbsp; Â· &nbsp;
                    <b>Colors:</b> ${esc(i.inkColors||"-")}
                  </div>

                  ${i.artNotes ? `<div style="margin-top:4px"><b>Notes:</b> <span style="white-space:pre-wrap">${esc(i.artNotes)}</span></div>` : ``}
                </div>
              `).join("")}
            </div>

            <div class="printItemImages">
              ${
                printImgs.length
                  ? printImgs.map(im => `<img src="${im.dataUrl}" alt="">`).join("")
                  : ``
              }
            </div>
          </div>
        </div>
      `;
    }).join("");

    $("printView").innerHTML = `
      <div style="padding:18px">
        <div style="display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap">
          <div>
            <div style="font-size:24px;font-weight:900">Work Order</div>
            <div style="color:#555">${esc(wo.woNumber)}</div>
          </div>
          <div style="font-size:13px;color:#333">
            <div><b>Created:</b> ${esc(wo.createdDate)}</div>
            <div><b>Due:</b> ${esc(wo.dueDate || "-")}</div>
            <div><b>Status:</b> ${esc(status)}</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div class="printCard">
            <div style="font-weight:900">Customer</div>
            <div>${esc(wo.customerName)}</div>
            <div>${esc(wo.company)}</div>
            <div>${esc(wo.email)}</div>
            <div>${esc(wo.phone)}</div>
          </div>
          <div class="printCard">
            <div style="font-weight:900">Addresses / Delivery</div>
            <div style="white-space:pre-wrap">${esc(wo.billingAddress||"")}</div>
            <div style="margin-top:8px;white-space:pre-wrap">${esc(wo.shippingAddress||"")}</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:900;margin-bottom:6px">Items</div>
          ${items}
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div class="printCard">
            <div style="font-weight:900">Customer Notes</div>
            <div style="white-space:pre-wrap">${esc(wo.notesCustomer||"-")}</div>
          </div>
          <div class="printCard">
            <div style="font-weight:900">Internal Notes</div>
            <div style="white-space:pre-wrap">${esc(wo.notesInternal||"-")}</div>
          </div>
        </div>

        <div class="printCard" style="margin-top:12px">
          <div style="font-weight:900">Approval</div>
          <div><b>Approved:</b> ${wo.approval.approved ? "Yes" : "No"}</div>
          <div><b>Name:</b> ${esc(wo.approval.approvedName||"-")}</div>
          <div><b>Date:</b> ${esc(wo.approval.approvedDate||"-")}</div>
        </div>
      </div>
    `;
  }

  // ====== EVENTS ======
  function bindTopInputs(){
    const bind = (id, path) => {
      $(id).addEventListener("input", (e)=>{ wo[path] = e.target.value; renderAll(); });
      $(id).addEventListener("change", (e)=>{ wo[path] = e.target.value; renderAll(); });
    };
    bind("createdDate","createdDate");
    bind("dueDate","dueDate");
    bind("customerName","customerName");
    bind("company","company");
    bind("email","email");
    bind("phone","phone");
    bind("billingAddress","billingAddress");
    bind("shippingAddress","shippingAddress");
    bind("notesCustomer","notesCustomer");
    bind("notesInternal","notesInternal");

    $("termsAccepted").addEventListener("change",(e)=>{ wo.approval.termsAccepted = !!e.target.checked; renderAll(); });
    $("approvedName").addEventListener("input",(e)=>{ wo.approval.approvedName = e.target.value; renderAll(); });

    // clear invalid highlight as user types
    document.querySelectorAll("input,textarea,select").forEach(el=>{
      el.addEventListener("input", ()=> el.classList.remove("invalid"));
      el.addEventListener("change", ()=> el.classList.remove("invalid"));
    });
  }

  function setTab(name){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    $("tab-items").classList.toggle("hidden", name!=="items");
    $("tab-notes").classList.toggle("hidden", name!=="notes");
    $("tab-approval").classList.toggle("hidden", name!=="approval");
  }

  function onServiceTypeChange(itemId, nextType){
    wo.items = wo.items.map(it => {
      if(it.id !== itemId) return it;
      const next = { ...it, serviceType: nextType };

      if(isGarment(nextType)){
        next.sizeBreakdown = newSizeBreakdown();
        next.quantity = sizeTotal(next.sizeBreakdown);
        next.itemSize = "";
      }else{
        next.sizeBreakdown = newSizeBreakdown();
        next.quantity = Number(next.quantity || 0);
        next.variantColor = "";
      }
      return next;
    });
  }

  function bindItemsEvents(){
    const wrap = $("itemsWrap");
    const MAX_IMAGES_PER_ITEM = 6;

    wrap.addEventListener("click", async (e)=>{
      const btn = e.target.closest("[data-action]");
      if(!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;

      if(action==="remove"){
        if(wo.items.length<=1) return;
        wo.items = wo.items.filter(i=>i.id!==id);
        toast("Item removed.");
        renderAll();
      }

      if(action==="dupColor"){
        const src = wo.items.find(i => i.id === id);
        if(!src) return;

        const clone = {
          ...src,
          id: crypto.randomUUID(),
          variantColor: "", // clear color so it's obvious what to change
        };

        wo.items.push(clone);
        toast("Added same item as a new line (different color).");
        renderAll();
      }

      if(action==="removeArtworkRef"){
        const idx = Number(btn.dataset.idx);
        const it = wo.items.find(i=>i.id===id);
        if(it && Array.isArray(it.artworkIds)){
          it.artworkIds.splice(idx, 1);
          toast("Artwork removed from this item.");
          renderAll();
        }
      }

      if(action==="clearArtworkRefs"){
        const it = wo.items.find(i=>i.id===id);
        if(it){
          it.artworkIds = [];
          toast("Artwork cleared from this item.");
          renderAll();
        }
      }

      if(action==="removeOneImage"){
        const idx = Number(btn.dataset.idx);
        const it = wo.items.find(i=>i.id===id);
        if(it && Array.isArray(it.images)){
          it.images.splice(idx, 1);
          toast("Image removed.");
          renderAll();
        }
      }

      if(action==="clearImages"){
        const it = wo.items.find(i=>i.id===id);
        if(it){
          it.images = [];
          toast("Images cleared.");
          renderAll();
        }
      }
    });

    wrap.addEventListener("change", async (e)=>{
      const el = e.target;

      // upload artwork (shared library)
      if(el.matches('[data-action="uploadArtwork"]')){
        const id = el.dataset.id;
        const files = Array.from(el.files || []);
        if(!files.length) return;

        const maxBytes = 6 * 1024 * 1024;
        const it = wo.items.find(i=>i.id===id);
        if(!it) return;

        if(!Array.isArray(wo.artworks)) wo.artworks = [];
        if(!Array.isArray(it.artworkIds)) it.artworkIds = [];

        for(const file of files){
          if(!file.type.startsWith("image/")){
            toast("One of the files is not an image (PNG/JPG/etc.).","error",3500);
            continue;
          }
          if(file.size > maxBytes){
            toast(`"${file.name}" is over 6MB. Please use a smaller file.`,"error",4200);
            continue;
          }

          const dataUrl = await readFileAsDataUrl(file);

          // De-dupe at the work order level
          let existing = wo.artworks.find(a => a.dataUrl === dataUrl);
          if(!existing){
            existing = { id: crypto.randomUUID(), name: file.name, dataUrl };
            wo.artworks.push(existing);
          }

          // Link to this item (no duplicates)
          if(!it.artworkIds.includes(existing.id)){
            it.artworkIds.push(existing.id);
          }
        }

        toast("Artwork attached.");
        renderAll();
        return;
      }

      // service type
      if(el.matches('select[data-field="serviceType"]')){
        onServiceTypeChange(el.dataset.id, el.value);
        renderAll();
        return;
      }

      // checkbox size
      if(el.matches('input[type="checkbox"][data-sizecheck]')){
        const [id, idxStr] = el.dataset.sizecheck.split(":");
        const idx = Number(idxStr);
        const it = wo.items.find(i=>i.id===id);
        if(it){
          const checked = !!el.checked;
          it.sizeBreakdown[idx].enabled = checked;

          // If unchecked, erase the qty
          if(!checked){
            it.sizeBreakdown[idx].qty = 0; // state
          }

          it.quantity = sizeTotal(it.sizeBreakdown);
          renderAll();
        }
        return;
      }

      // size qty
      if(el.matches('input[type="number"][data-sizeqty]')){
        const [id, idxStr] = el.dataset.sizeqty.split(":");
        const idx = Number(idxStr);
        const it = wo.items.find(i=>i.id===id);
        if(it){
          it.sizeBreakdown[idx].qty = Number(el.value || 0);
          it.quantity = sizeTotal(it.sizeBreakdown);
          renderAll();
        }
        return;
      }

      // normal fields
      const field = el.dataset.field;
      const id = el.dataset.id;
      if(field && id){
        const it = wo.items.find(i=>i.id===id);
        if(it){
          it[field] = (el.type==="number") ? Number(el.value||0) : el.value;
          renderAll();
        }
      }
    });

    wrap.addEventListener("input",(e)=>{
      const el = e.target;
      const field = el.dataset.field;
      const id = el.dataset.id;
      if(field && id){
        const it = wo.items.find(i=>i.id===id);
        if(it){
          it[field] = el.value;
          if(field==="quantity") it.quantity = Number(el.value||0);
          saveDraft();
          updateSummary();
        }
      }
    });
  }

  // ====== INIT ======
  function init(){
    wo = newWO();
    loadDraft();
    if(!wo) wo = newWO();

    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", ()=> setTab(t.dataset.tab));
    });

    $("addItem").addEventListener("click", ()=>{
      const next = defaultItem();

      // Safe checkbox lookup (no optional chaining)
      const sameBox = document.getElementById("sameArtNext");
      const useSame = sameBox && sameBox.checked;

      if(useSame && wo.items.length){
        const last = wo.items[wo.items.length - 1];
        next.artworkIds = Array.isArray(last.artworkIds) ? last.artworkIds.slice() : [];
      }

      wo.items.push(next);
      toast("Item added.");
      renderAll();
    });

    $("newWO").addEventListener("click", ()=>{
      wo = newWO();
      saveDraft();
      toast("Started a new work order.");
      renderAll();
    });

    $("markApproved").addEventListener("click", markApproved);
    $("clearApproval").addEventListener("click", clearApproval);

    $("previewCustomer").addEventListener("click", openPreview);
    $("closeModal").addEventListener("click", closePreview);
    $("modalClose2").addEventListener("click", closePreview);
    $("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === $("modalBackdrop")) closePreview(); });

    $("printBtn").addEventListener("click", async ()=>{
      validateAllRequired({ includeApproval: false });
      buildPrintView();

      await waitForImages($("printView"));
      await new Promise(r => setTimeout(r, 150)); // Safari-friendly

      window.print();
    });
    $("modalPrint").addEventListener("click", async ()=>{
      if(!validateAllRequired({ includeApproval: false })) return;
      buildPrintView();

      await waitForImages($("printView"));
      await new Promise(r => setTimeout(r, 150));

      closePreview();
      window.print();
    });

    bindTopInputs();
    bindItemsEvents();

    renderAll();
  }

  init();
})();
</script>
</body>
</html>
